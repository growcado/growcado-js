"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;
var _middleware = require("@verdaccio/middleware");
var _constants = require("../../../lib/constants");
var _logger = require("../../../lib/logger");
function _default(route, auth, storage) {
  // searching packages
  route.get(_middleware.SEARCH_API_ENDPOINTS.deprecated_search, function (req, res, next) {
    let received_end = false;
    let response_finished = false;
    let processing_pkgs = 0;
    let firstPackage = true;
    _logger.logger.warn('/-/all search endpoint is deprecated, might be removed in the next major release');
    res.status(200);
    res.set(_constants.HEADERS.CONTENT_TYPE, _constants.HEADERS.JSON_CHARSET);

    /*
     * Offical NPM registry (registry.npmjs.org) no longer return whole database,
     * They only return packages matched with keyword in `referer: search pkg-name`,
     * And NPM client will request server in every search.
     *
     * The magic number 99999 was sent by NPM registry. Modify it may caused strange
     * behaviour in the future.
     *
     * BTW: NPM will not return result if user-agent does not contain string 'npm',
     * See: method 'request' in up-storage.js
     *
     * If there is no cache in local, NPM will request /-/all, then get response with
     * _updated: 99999, 'Date' in response header was Mon, 10 Oct 1983 00:12:48 GMT,
     * this will make NPM always query from server
     *
     * Data structure also different, whel request /-/all, response is an object, but
     * when request /-/all/since, response is an array
     */
    const respShouldBeArray = req.path.endsWith('/since');
    if (!respShouldBeArray) {
      res.set('Date', 'Mon, 10 Oct 1983 00:12:48 GMT');
    }
    const check_finish = function () {
      if (!received_end) {
        return;
      }
      if (processing_pkgs) {
        return;
      }
      if (response_finished) {
        return;
      }
      response_finished = true;
      if (respShouldBeArray) {
        res.end(']\n');
      } else {
        res.end('}\n');
      }
    };
    if (respShouldBeArray) {
      res.write('[');
    } else {
      res.write('{"_updated":' + 99999);
    }
    const stream = storage.search(req.query.startkey || 0, {
      req: req
    });
    stream.on('data', function each(pkg) {
      processing_pkgs++;
      auth.allow_access({
        packageName: pkg.name
      }, req.remote_user, function (err, allowed) {
        processing_pkgs--;
        if (err) {
          if (err.status && String(err.status).match(/^4\d\d$/)) {
            // auth plugin returns 4xx user error,
            // that's equivalent of !allowed basically
            allowed = false;
          } else {
            stream.abort(err);
          }
        }
        if (allowed) {
          if (respShouldBeArray) {
            res.write(`${firstPackage ? '' : ','}${JSON.stringify(pkg)}\n`);
            if (firstPackage) {
              firstPackage = false;
            }
          } else {
            res.write(',\n' + JSON.stringify(pkg.name) + ':' + JSON.stringify(pkg));
          }
        }
        check_finish();
      });
    });
    stream.on('error', function (err) {
      _logger.logger.error('search `/-/all endpoint has failed @{err}', err);
      received_end = true;
      check_finish();
    });
    stream.on('end', function () {
      received_end = true;
      check_finish();
    });
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbWlkZGxld2FyZSIsInJlcXVpcmUiLCJfY29uc3RhbnRzIiwiX2xvZ2dlciIsIl9kZWZhdWx0Iiwicm91dGUiLCJhdXRoIiwic3RvcmFnZSIsImdldCIsIlNFQVJDSF9BUElfRU5EUE9JTlRTIiwiZGVwcmVjYXRlZF9zZWFyY2giLCJyZXEiLCJyZXMiLCJuZXh0IiwicmVjZWl2ZWRfZW5kIiwicmVzcG9uc2VfZmluaXNoZWQiLCJwcm9jZXNzaW5nX3BrZ3MiLCJmaXJzdFBhY2thZ2UiLCJsb2dnZXIiLCJ3YXJuIiwic3RhdHVzIiwic2V0IiwiSEVBREVSUyIsIkNPTlRFTlRfVFlQRSIsIkpTT05fQ0hBUlNFVCIsInJlc3BTaG91bGRCZUFycmF5IiwicGF0aCIsImVuZHNXaXRoIiwiY2hlY2tfZmluaXNoIiwiZW5kIiwid3JpdGUiLCJzdHJlYW0iLCJzZWFyY2giLCJxdWVyeSIsInN0YXJ0a2V5Iiwib24iLCJlYWNoIiwicGtnIiwiYWxsb3dfYWNjZXNzIiwicGFja2FnZU5hbWUiLCJuYW1lIiwicmVtb3RlX3VzZXIiLCJlcnIiLCJhbGxvd2VkIiwiU3RyaW5nIiwibWF0Y2giLCJhYm9ydCIsIkpTT04iLCJzdHJpbmdpZnkiLCJlcnJvciJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9hcGkvZW5kcG9pbnQvYXBpL3NlYXJjaC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTRUFSQ0hfQVBJX0VORFBPSU5UUyB9IGZyb20gJ0B2ZXJkYWNjaW8vbWlkZGxld2FyZSc7XG5cbmltcG9ydCB7IEhFQURFUlMgfSBmcm9tICcuLi8uLi8uLi9saWIvY29uc3RhbnRzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uLy4uLy4uL2xpYi9sb2dnZXInO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiAocm91dGUsIGF1dGgsIHN0b3JhZ2UpOiB2b2lkIHtcbiAgLy8gc2VhcmNoaW5nIHBhY2thZ2VzXG4gIHJvdXRlLmdldChTRUFSQ0hfQVBJX0VORFBPSU5UUy5kZXByZWNhdGVkX3NlYXJjaCwgZnVuY3Rpb24gKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgbGV0IHJlY2VpdmVkX2VuZCA9IGZhbHNlO1xuICAgIGxldCByZXNwb25zZV9maW5pc2hlZCA9IGZhbHNlO1xuICAgIGxldCBwcm9jZXNzaW5nX3BrZ3MgPSAwO1xuICAgIGxldCBmaXJzdFBhY2thZ2UgPSB0cnVlO1xuICAgIGxvZ2dlci53YXJuKCcvLS9hbGwgc2VhcmNoIGVuZHBvaW50IGlzIGRlcHJlY2F0ZWQsIG1pZ2h0IGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZScpO1xuICAgIHJlcy5zdGF0dXMoMjAwKTtcbiAgICByZXMuc2V0KEhFQURFUlMuQ09OVEVOVF9UWVBFLCBIRUFERVJTLkpTT05fQ0hBUlNFVCk7XG5cbiAgICAvKlxuICAgICAqIE9mZmljYWwgTlBNIHJlZ2lzdHJ5IChyZWdpc3RyeS5ucG1qcy5vcmcpIG5vIGxvbmdlciByZXR1cm4gd2hvbGUgZGF0YWJhc2UsXG4gICAgICogVGhleSBvbmx5IHJldHVybiBwYWNrYWdlcyBtYXRjaGVkIHdpdGgga2V5d29yZCBpbiBgcmVmZXJlcjogc2VhcmNoIHBrZy1uYW1lYCxcbiAgICAgKiBBbmQgTlBNIGNsaWVudCB3aWxsIHJlcXVlc3Qgc2VydmVyIGluIGV2ZXJ5IHNlYXJjaC5cbiAgICAgKlxuICAgICAqIFRoZSBtYWdpYyBudW1iZXIgOTk5OTkgd2FzIHNlbnQgYnkgTlBNIHJlZ2lzdHJ5LiBNb2RpZnkgaXQgbWF5IGNhdXNlZCBzdHJhbmdlXG4gICAgICogYmVoYXZpb3VyIGluIHRoZSBmdXR1cmUuXG4gICAgICpcbiAgICAgKiBCVFc6IE5QTSB3aWxsIG5vdCByZXR1cm4gcmVzdWx0IGlmIHVzZXItYWdlbnQgZG9lcyBub3QgY29udGFpbiBzdHJpbmcgJ25wbScsXG4gICAgICogU2VlOiBtZXRob2QgJ3JlcXVlc3QnIGluIHVwLXN0b3JhZ2UuanNcbiAgICAgKlxuICAgICAqIElmIHRoZXJlIGlzIG5vIGNhY2hlIGluIGxvY2FsLCBOUE0gd2lsbCByZXF1ZXN0IC8tL2FsbCwgdGhlbiBnZXQgcmVzcG9uc2Ugd2l0aFxuICAgICAqIF91cGRhdGVkOiA5OTk5OSwgJ0RhdGUnIGluIHJlc3BvbnNlIGhlYWRlciB3YXMgTW9uLCAxMCBPY3QgMTk4MyAwMDoxMjo0OCBHTVQsXG4gICAgICogdGhpcyB3aWxsIG1ha2UgTlBNIGFsd2F5cyBxdWVyeSBmcm9tIHNlcnZlclxuICAgICAqXG4gICAgICogRGF0YSBzdHJ1Y3R1cmUgYWxzbyBkaWZmZXJlbnQsIHdoZWwgcmVxdWVzdCAvLS9hbGwsIHJlc3BvbnNlIGlzIGFuIG9iamVjdCwgYnV0XG4gICAgICogd2hlbiByZXF1ZXN0IC8tL2FsbC9zaW5jZSwgcmVzcG9uc2UgaXMgYW4gYXJyYXlcbiAgICAgKi9cbiAgICBjb25zdCByZXNwU2hvdWxkQmVBcnJheSA9IHJlcS5wYXRoLmVuZHNXaXRoKCcvc2luY2UnKTtcbiAgICBpZiAoIXJlc3BTaG91bGRCZUFycmF5KSB7XG4gICAgICByZXMuc2V0KCdEYXRlJywgJ01vbiwgMTAgT2N0IDE5ODMgMDA6MTI6NDggR01UJyk7XG4gICAgfVxuICAgIGNvbnN0IGNoZWNrX2ZpbmlzaCA9IGZ1bmN0aW9uICgpOiB2b2lkIHtcbiAgICAgIGlmICghcmVjZWl2ZWRfZW5kKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmIChwcm9jZXNzaW5nX3BrZ3MpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgaWYgKHJlc3BvbnNlX2ZpbmlzaGVkKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHJlc3BvbnNlX2ZpbmlzaGVkID0gdHJ1ZTtcbiAgICAgIGlmIChyZXNwU2hvdWxkQmVBcnJheSkge1xuICAgICAgICByZXMuZW5kKCddXFxuJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuZW5kKCd9XFxuJyk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIGlmIChyZXNwU2hvdWxkQmVBcnJheSkge1xuICAgICAgcmVzLndyaXRlKCdbJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlcy53cml0ZSgne1wiX3VwZGF0ZWRcIjonICsgOTk5OTkpO1xuICAgIH1cblxuICAgIGNvbnN0IHN0cmVhbSA9IHN0b3JhZ2Uuc2VhcmNoKHJlcS5xdWVyeS5zdGFydGtleSB8fCAwLCB7IHJlcTogcmVxIH0pO1xuXG4gICAgc3RyZWFtLm9uKCdkYXRhJywgZnVuY3Rpb24gZWFjaChwa2cpIHtcbiAgICAgIHByb2Nlc3NpbmdfcGtncysrO1xuXG4gICAgICBhdXRoLmFsbG93X2FjY2Vzcyh7IHBhY2thZ2VOYW1lOiBwa2cubmFtZSB9LCByZXEucmVtb3RlX3VzZXIsIGZ1bmN0aW9uIChlcnIsIGFsbG93ZWQpIHtcbiAgICAgICAgcHJvY2Vzc2luZ19wa2dzLS07XG5cbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIGlmIChlcnIuc3RhdHVzICYmIFN0cmluZyhlcnIuc3RhdHVzKS5tYXRjaCgvXjRcXGRcXGQkLykpIHtcbiAgICAgICAgICAgIC8vIGF1dGggcGx1Z2luIHJldHVybnMgNHh4IHVzZXIgZXJyb3IsXG4gICAgICAgICAgICAvLyB0aGF0J3MgZXF1aXZhbGVudCBvZiAhYWxsb3dlZCBiYXNpY2FsbHlcbiAgICAgICAgICAgIGFsbG93ZWQgPSBmYWxzZTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3RyZWFtLmFib3J0KGVycik7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFsbG93ZWQpIHtcbiAgICAgICAgICBpZiAocmVzcFNob3VsZEJlQXJyYXkpIHtcbiAgICAgICAgICAgIHJlcy53cml0ZShgJHtmaXJzdFBhY2thZ2UgPyAnJyA6ICcsJ30ke0pTT04uc3RyaW5naWZ5KHBrZyl9XFxuYCk7XG4gICAgICAgICAgICBpZiAoZmlyc3RQYWNrYWdlKSB7XG4gICAgICAgICAgICAgIGZpcnN0UGFja2FnZSA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXMud3JpdGUoJyxcXG4nICsgSlNPTi5zdHJpbmdpZnkocGtnLm5hbWUpICsgJzonICsgSlNPTi5zdHJpbmdpZnkocGtnKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY2hlY2tfZmluaXNoKCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHN0cmVhbS5vbignZXJyb3InLCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ3NlYXJjaCBgLy0vYWxsIGVuZHBvaW50IGhhcyBmYWlsZWQgQHtlcnJ9JywgZXJyKTtcbiAgICAgIHJlY2VpdmVkX2VuZCA9IHRydWU7XG4gICAgICBjaGVja19maW5pc2goKTtcbiAgICB9KTtcblxuICAgIHN0cmVhbS5vbignZW5kJywgZnVuY3Rpb24gKCkge1xuICAgICAgcmVjZWl2ZWRfZW5kID0gdHJ1ZTtcbiAgICAgIGNoZWNrX2ZpbmlzaCgpO1xuICAgIH0pO1xuICB9KTtcbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBQUEsV0FBQSxHQUFBQyxPQUFBO0FBRUEsSUFBQUMsVUFBQSxHQUFBRCxPQUFBO0FBQ0EsSUFBQUUsT0FBQSxHQUFBRixPQUFBO0FBRWUsU0FBQUcsU0FBVUMsS0FBSyxFQUFFQyxJQUFJLEVBQUVDLE9BQU8sRUFBUTtFQUNuRDtFQUNBRixLQUFLLENBQUNHLEdBQUcsQ0FBQ0MsZ0NBQW9CLENBQUNDLGlCQUFpQixFQUFFLFVBQVVDLEdBQUcsRUFBRUMsR0FBRyxFQUFFQyxJQUFJLEVBQUU7SUFDMUUsSUFBSUMsWUFBWSxHQUFHLEtBQUs7SUFDeEIsSUFBSUMsaUJBQWlCLEdBQUcsS0FBSztJQUM3QixJQUFJQyxlQUFlLEdBQUcsQ0FBQztJQUN2QixJQUFJQyxZQUFZLEdBQUcsSUFBSTtJQUN2QkMsY0FBTSxDQUFDQyxJQUFJLENBQUMsa0ZBQWtGLENBQUM7SUFDL0ZQLEdBQUcsQ0FBQ1EsTUFBTSxDQUFDLEdBQUcs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