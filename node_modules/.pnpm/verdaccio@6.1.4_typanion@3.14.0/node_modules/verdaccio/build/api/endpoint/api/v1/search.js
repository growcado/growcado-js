"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;
var _lodash = _interopRequireDefault(require("lodash"));
var _semver = _interopRequireDefault(require("semver"));
var _middleware = require("@verdaccio/middleware");
var _constants = require("../../../../lib/constants");
var _logger = require("../../../../lib/logger");
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
const personMatch = (person, search) => {
  if (typeof person === 'string') {
    return person.includes(search);
  }
  if (typeof person === 'object') {
    for (const field of Object.values(person)) {
      if (typeof field === 'string' && field.includes(search)) {
        return true;
      }
    }
  }
  return false;
};
const matcher = function (query) {
  const match = query.match(/author:(.*)/);
  if (match !== null) {
    return function (pkg) {
      return personMatch(pkg.author, match[1]);
    };
  }

  // TODO: maintainer, keywords, boost-exact
  // TODO implement some scoring system for freetext
  return pkg => {
    return ['name', 'displayName', 'description'].map(k => {
      return pkg[k];
    }).filter(x => {
      return x !== undefined;
    }).some(txt => {
      return txt.includes(query);
    });
  };
};
function compileTextSearch(textSearch) {
  const textMatchers = (textSearch || '').split(' ').map(matcher);
  return pkg => textMatchers.every(m => m(pkg));
}
function removeDuplicates(results) {
  const pkgNames = [];
  return results.filter(pkg => {
    var _pkg$package, _pkg$package2;
    if (pkgNames.includes(pkg === null || pkg === void 0 ? void 0 : (_pkg$package = pkg.package) === null || _pkg$package === void 0 ? void 0 : _pkg$package.name)) {
      return false;
    }
    pkgNames.push(pkg === null || pkg === void 0 ? void 0 : (_pkg$package2 = pkg.package) === null || _pkg$package2 === void 0 ? void 0 : _pkg$package2.name);
    return true;
  });
}
function checkAccess(pkg, auth, remoteUser) {
  return new Promise((resolve, reject) => {
    var _pkg$package3;
    auth.allow_access({
      packageName: pkg === null || pkg === void 0 ? void 0 : (_pkg$package3 = pkg.package) === null || _pkg$package3 === void 0 ? void 0 : _pkg$package3.name
    }, remoteUser, function (err, allowed) {
      if (err) {
        if (err.status && String(err.status).match(/^4\d\d$/)) {
          // auth plugin returns 4xx user error,
          // that's equivalent of !allowed basically
          allowed = false;
          return resolve(null);
        } else {
          reject(err);
        }
      } else {
        return resolve(allowed ? pkg : null);
      }
    });
  });
}
async function sendResponse(resultBuf, resultStream, auth, req, from, size) {
  resultStream.destroy();
  const resultsCollection = resultBuf.map(pkg => {
    if (pkg !== null && pkg !== void 0 && pkg.name) {
      return {
        package: pkg,
        // not sure if flags is need it
        flags: {
          unstable: Object.keys(pkg.versions).some(v => _semver.default.satisfies(v, '^1.0.0')) ? undefined : true
        },
        local: true,
        score: {
          final: 1,
          detail: {
            quality: 1,
            popularity: 1,
            maintenance: 0
          }
        },
        searchScore: 100000
      };
    } else {
      return pkg;
    }
  });
  const checkAccessPromises = await Promise.all(removeDuplicates(resultsCollection).map(pkgItem => {
    return checkAccess(pkgItem, auth, req.remote_user);
  }));
  const final = checkAccessPromises.filter(i => !_lodash.default.isNull(i)).slice(from, size);
  _logger.logger.debug(`search results ${final === null || final === void 0 ? void 0 : final.length}`);
  const response = {
    objects: final,
    total: final.length,
    time: new Date().toUTCString()
  };
  _logger.logger.debug(`total response ${final.length}`);
  return response;
}

/**
 * Endpoint for npm search v1
 * req: 'GET /-/v1/search?text=react&size=20&from=0&quality=0.65&popularity=0.98&maintenance=0.5'
 */
function _default(route, auth, storage) {
  route.get(_middleware.SEARCH_API_ENDPOINTS.search, async (req, res, next) => {
    // TODO: implement proper result scoring weighted by quality, popularity and maintenance query parameters
    let [text, size, from /* , quality, popularity, maintenance */] = ['text', 'size', 'from' /* , 'quality', 'popularity', 'maintenance' */].map(k => req.query[k]);
    size = parseInt(size) || 20;
    from = parseInt(from) || 0;
    const isInteresting = compileTextSearch(text);
    const resultStream = storage.search(0, {
      req
    });
    let resultBuf = [];
    let completed = false;
    resultStream.on('data', pkg => {
      // packages from the upstreams
      if (_lodash.default.isArray(pkg)) {
        resultBuf = resultBuf.concat(pkg.filter(pkgItem => {
          var _pkgItem$package;
          if (!isInteresting(pkgItem === null || pkgItem === void 0 ? void 0 : pkgItem.package)) {
            return;
          }
          _logger.logger.debug(`[remote] pkg name ${pkgItem === null || pkgItem === void 0 ? void 0 : (_pkgItem$package = pkgItem.package) === null || _pkgItem$package === void 0 ? void 0 : _pkgItem$package.name}`);
          return true;
        }));
      } else {
        // packages from local
        // due compability with `/-/all` we cannot refactor storage.search();
        if (!isInteresting(pkg)) {
          return;
        }
        _logger.logger.debug(`[local] pkg name ${pkg === null || pkg === void 0 ? void 0 : pkg.name}`);
        resultBuf.push(pkg);
      }
    });
    resultStream.on('error', function () {
      _logger.logger.error('search endpoint has failed');
      res.socket.destroy();
    });
    resultStream.on('end', async () => {
      if (!completed) {
        completed = true;
        try {
          const response = await sendResponse(resultBuf, resultStream, auth, req, from, size);
          _logger.logger.info('search endpoint ok results @{total}', {
            total: response.total
          });
          res.status(_constants.HTTP_STATUS.OK).json(response);
        } catch (err) {
          _logger.logger.error('search endpoint has failed @{err}', {
            err
          });
          next(err);
        }
      }
    });
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbG9kYXNoIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfc2VtdmVyIiwiX21pZGRsZXdhcmUiLCJfY29uc3RhbnRzIiwiX2xvZ2dlciIsImUiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsInBlcnNvbk1hdGNoIiwicGVyc29uIiwic2VhcmNoIiwiaW5jbHVkZXMiLCJmaWVsZCIsIk9iamVjdCIsInZhbHVlcyIsIm1hdGNoZXIiLCJxdWVyeSIsIm1hdGNoIiwicGtnIiwiYXV0aG9yIiwibWFwIiwiayIsImZpbHRlciIsIngiLCJ1bmRlZmluZWQiLCJzb21lIiwidHh0IiwiY29tcGlsZVRleHRTZWFyY2giLCJ0ZXh0U2VhcmNoIiwidGV4dE1hdGNoZXJzIiwic3BsaXQiLCJldmVyeSIsIm0iLCJyZW1vdmVEdXBsaWNhdGVzIiwicmVzdWx0cyIsInBrZ05hbWVzIiwiX3BrZyRwYWNrYWdlIiwiX3BrZyRwYWNrYWdlMiIsInBhY2thZ2UiLCJuYW1lIiwicHVzaCIsImNoZWNrQWNjZXNzIiwiYXV0aCIsInJlbW90ZVVzZXIiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsIl9wa2ckcGFja2FnZTMiLCJhbGxvd19hY2Nlc3MiLCJwYWNrYWdlTmFtZSIsImVyciIsImFsbG93ZWQiLCJzdGF0dXMiLCJTdHJpbmciLCJzZW5kUmVzcG9uc2UiLCJyZXN1bHRCdWYiLCJyZXN1bHRTdHJlYW0iLCJyZXEiLCJmcm9tIiwic2l6ZSIsImRlc3Ryb3kiLCJyZXN1bHRzQ29sbGVjdGlvbiIsImZsYWdzIiwidW5zdGFibGUiLCJrZXlzIiwidmVyc2lvbnMiLCJ2Iiwic2VtdmVyIiwic2F0aXNmaWVzIiwibG9jYWwiLCJzY29yZSIsImZpbmFsIiwiZGV0YWlsIiwicXVhbGl0eSIsInBvcHVsYXJpdHkiLCJtYWludGVuYW5jZSIsInNlYXJjaFNjb3JlIiwiY2hlY2tBY2Nlc3NQcm9taXNlcyIsImFsbCIsInBrZ0l0ZW0iLCJyZW1vdGVfdXNlciIsImkiLCJfIiwiaXNOdWxsIiwic2xpY2UiLCJsb2dnZXIiLCJkZWJ1ZyIsImxlbmd0aCIsInJlc3BvbnNlIiwib2JqZWN0cyIsInRvdGFsIiwidGltZSIsIkRhdGUiLCJ0b1VUQ1N0cmluZyIsIl9kZWZhdWx0Iiwicm91dGUiLCJzdG9yYWdlIiwiZ2V0IiwiU0VBUkNIX0FQSV9FTkRQT0lOVFMiLCJyZXMiLCJuZXh0IiwidGV4dCIsInBhcnNlSW50IiwiaXNJbnRlcmVzdGluZyIsImNvbXBsZXRlZCIsIm9uIiwiaXNBcnJheSIsImNvbmNhdCIsIl9wa2dJdGVtJHBhY2thZ2UiLCJlcnJvciIsInNvY2tldCIsImluZm8iLCJIVFRQX1NUQVRVUyIsIk9LIiwianNvbiJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9hcGkvZW5kcG9pbnQvYXBpL3YxL3NlYXJjaC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHNlbXZlciBmcm9tICdzZW12ZXInO1xuXG5pbXBvcnQgeyBTRUFSQ0hfQVBJX0VORFBPSU5UUyB9IGZyb20gJ0B2ZXJkYWNjaW8vbWlkZGxld2FyZSc7XG5pbXBvcnQgeyBNYW5pZmVzdCB9IGZyb20gJ0B2ZXJkYWNjaW8vdHlwZXMnO1xuXG5pbXBvcnQgeyBIVFRQX1NUQVRVUyB9IGZyb20gJy4uLy4uLy4uLy4uL2xpYi9jb25zdGFudHMnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vLi4vLi4vLi4vbGliL2xvZ2dlcic7XG5cbnR5cGUgUHVibGlzaGVyTWFpbnRhaW5lciA9IHtcbiAgdXNlcm5hbWU6IHN0cmluZztcbiAgZW1haWw6IHN0cmluZztcbn07XG5cbnR5cGUgUGFja2FnZVJlc3VsdHMgPSB7XG4gIG5hbWU6IHN0cmluZztcbiAgc2NvcGU6IHN0cmluZztcbiAgdmVyc2lvbjogc3RyaW5nO1xuICBkZXNjcmlwdGlvbjogc3RyaW5nO1xuICBkYXRlOiBzdHJpbmc7XG4gIGxpbmtzOiB7XG4gICAgbnBtOiBzdHJpbmc7XG4gICAgaG9tZXBhZ2U/OiBzdHJpbmc7XG4gICAgcmVwb3NpdG9yeT86IHN0cmluZztcbiAgICBidWdzPzogc3RyaW5nO1xuICB9O1xuICBhdXRob3I6IHsgbmFtZTogc3RyaW5nIH07XG4gIHB1Ymxpc2hlcjogUHVibGlzaGVyTWFpbnRhaW5lcjtcbiAgbWFpbnRhaW5lcjogUHVibGlzaGVyTWFpbnRhaW5lcjtcbn07XG5cbnR5cGUgU2VhcmNoUmVzdWx0ID0ge1xuICBwYWNrYWdlOiBQYWNrYWdlUmVzdWx0cztcbiAgZmxhZ3M/OiB7IHVuc3RhYmxlOiBib29sZWFuIHwgdm9pZCB9O1xuICBsb2NhbD86IGJvb2xlYW47XG4gIHNjb3JlOiB7XG4gICAgZmluYWw6IG51bWJlcjtcbiAgICBkZXRhaWw6IHtcbiAgICAgIHF1YWxpdHk6IG51bWJlcjtcbiAgICAgIHBvcHVsYXJpdHk6IG51bWJlcjtcbiAgICAgIG1haW50ZW5hbmNlOiBudW1iZXI7XG4gICAgfTtcbiAgfTtcbiAgc2VhcmNoU2NvcmU6IG51bWJlcjtcbn07XG5cbnR5cGUgU2VhcmNoUmVzdWx0cyA9IHtcbiAgb2JqZWN0czogU2VhcmNoUmVzdWx0W107XG4gIHRvdGFsOiBudW1iZXI7XG4gIHRpbWU6IHN0cmluZztcbn07XG5cbmNvbnN0IHBlcnNvbk1hdGNoID0gKHBlcnNvbiwgc2VhcmNoKSA9PiB7XG4gIGlmICh0eXBlb2YgcGVyc29uID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiBwZXJzb24uaW5jbHVkZXMoc2VhcmNoKTtcbiAgfVxuXG4gIGlmICh0eXBlb2YgcGVyc29uID09PSAnb2JqZWN0Jykge1xuICAgIGZvciAoY29uc3QgZmllbGQgb2YgT2JqZWN0LnZhbHVlcyhwZXJzb24pKSB7XG4gICAgICBpZiAodHlwZW9mIGZpZWxkID09PSAnc3RyaW5nJyAmJiBmaWVsZC5pbmNsdWRlcyhzZWFyY2gpKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBmYWxzZTtcbn07XG5cbmNvbnN0IG1hdGNoZXIgPSBmdW5jdGlvbiAocXVlcnkpIHtcbiAgY29uc3QgbWF0Y2ggPSBxdWVyeS5tYXRjaCgvYXV0aG9yOiguKikvKTtcbiAgaWYgKG1hdGNoICE9PSBudWxsKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uIChwa2cpIHtcbiAgICAgIHJldHVybiBwZXJzb25NYXRjaChwa2cuYXV0aG9yLCBtYXRjaFsxXSk7XG4gICAgfTtcbiAgfVxuXG4gIC8vIFRPRE86IG1haW50YWluZXIsIGtleXdvcmRzLCBib29zdC1leGFjdFxuICAvLyBUT0RPIGltcGxlbWVudCBzb21lIHNjb3Jpbmcgc3lzdGVtIGZvciBmcmVldGV4dFxuICByZXR1cm4gKHBrZykgPT4ge1xuICAgIHJldHVybiBbJ25hbWUnLCAnZGlzcGxheU5hbWUnLCAnZGVzY3JpcHRpb24nXVxuICAgICAgLm1hcCgoaykgPT4ge1xuICAgICAgICByZXR1cm4gcGtnW2tdO1xuICAgICAgfSlcbiAgICAgIC5maWx0ZXIoKHgpID0+IHtcbiAgICAgICAgcmV0dXJuIHggIT09IHVuZGVmaW5lZDtcbiAgICAgIH0pXG4gICAgICAuc29tZSgodHh0KSA9PiB7XG4gICAgICAgIHJldHVybiB0eHQuaW5jbHVkZXMocXVlcnkpO1xuICAgICAgfSk7XG4gIH07XG59O1xuXG5mdW5jdGlvbiBjb21waWxlVGV4dFNlYXJjaCh0ZXh0U2VhcmNoOiBzdHJpbmcpOiAocGtnOiBQYWNrYWdlUmVzdWx0cykgPT4gYm9vbGVhbiB7XG4gIGNvbnN0IHRleHRNYXRjaGVycyA9ICh0ZXh0U2VhcmNoIHx8ICcnKS5zcGxpdCgnICcpLm1hcChtYXRjaGVyKTtcbiAgcmV0dXJuIChwa2cpID0+IHRleHRNYXRjaGVycy5ldmVyeSgobSkgPT4gbShwa2cpKTtcbn1cblxuZnVuY3Rpb24gcmVtb3ZlRHVwbGljYXRlcyhyZXN1bHRzKSB7XG4gIGNvbnN0IHBrZ05hbWVzOiBhbnlbXSA9IFtdO1xuICByZXR1cm4gcmVzdWx0cy5maWx0ZXIoKHBrZykgPT4ge1xuICAgIGlmIChwa2dOYW1lcy5pbmNsdWRlcyhwa2c/LnBhY2thZ2U/Lm5hbWUpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHBrZ05hbWVzLnB1c2gocGtnPy5wYWNrYWdlPy5uYW1lKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGNoZWNrQWNjZXNzKHBrZzogYW55LCBhdXRoOiBhbnksIHJlbW90ZVVzZXIpOiBQcm9taXNlPE1hbmlmZXN0IHwgbnVsbD4ge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGF1dGguYWxsb3dfYWNjZXNzKHsgcGFja2FnZU5hbWU6IHBrZz8ucGFja2FnZT8ubmFtZSB9LCByZW1vdGVVc2VyLCBmdW5jdGlvbiAoZXJyLCBhbGxvd2VkKSB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIGlmIChlcnIuc3RhdHVzICYmIFN0cmluZyhlcnIuc3RhdHVzKS5tYXRjaCgvXjRcXGRcXGQkLykpIHtcbiAgICAgICAgICAvLyBhdXRoIHBsdWdpbiByZXR1cm5zIDR4eCB1c2VyIGVycm9yLFxuICAgICAgICAgIC8vIHRoYXQncyBlcXVpdmFsZW50IG9mICFhbGxvd2VkIGJhc2ljYWxseVxuICAgICAgICAgIGFsbG93ZWQgPSBmYWxzZTtcbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZShudWxsKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHJlc29sdmUoYWxsb3dlZCA/IHBrZyA6IG51bGwpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2VuZFJlc3BvbnNlKFxuICByZXN1bHRCdWYsXG4gIHJlc3VsdFN0cmVhbSxcbiAgYXV0aCxcbiAgcmVxLFxuICBmcm9tOiBudW1iZXIsXG4gIHNpemU6IG51bWJlclxuKTogUHJvbWlzZTxTZWFyY2hSZXN1bHRzPiB7XG4gIHJlc3VsdFN0cmVhbS5kZXN0cm95KCk7XG4gIGNvbnN0IHJlc3VsdHNDb2xsZWN0aW9uID0gcmVzdWx0QnVmLm1hcCgocGtnKTogU2VhcmNoUmVzdWx0ID0+IHtcbiAgICBpZiAocGtnPy5uYW1lKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwYWNrYWdlOiBwa2csXG4gICAgICAgIC8vIG5vdCBzdXJlIGlmIGZsYWdzIGlzIG5lZWQgaXRcbiAgICAgICAgZmxhZ3M6IHtcbiAgICAgICAgICB1bnN0YWJsZTogT2JqZWN0LmtleXMocGtnLnZlcnNpb25zKS5zb21lKCh2KSA9PiBzZW12ZXIuc2F0aXNmaWVzKHYsICdeMS4wLjAnKSlcbiAgICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgICA6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICAgIGxvY2FsOiB0cnVlLFxuICAgICAgICBzY29yZToge1xuICAgICAgICAgIGZpbmFsOiAxLFxuICAgICAgICAgIGRldGFpbDoge1xuICAgICAgICAgICAgcXVhbGl0eTogMSxcbiAgICAgICAgICAgIHBvcHVsYXJpdHk6IDEsXG4gICAgICAgICAgICBtYWludGVuYW5jZTogMCxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBzZWFyY2hTY29yZTogMTAwMDAwLFxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHBrZztcbiAgICB9XG4gIH0pO1xuICBjb25zdCBjaGVja0FjY2Vzc1Byb21pc2VzOiBTZWFyY2hSZXN1bHRbXSA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgIHJlbW92ZUR1cGxpY2F0ZXMocmVzdWx0c0NvbGxlY3Rpb24pLm1hcCgocGtnSXRlbSkgPT4ge1xuICAgICAgcmV0dXJuIGNoZWNrQWNjZXNzKHBrZ0l0ZW0sIGF1dGgsIHJlcS5yZW1vdGVfdXNlcik7XG4gICAgfSlcbiAgKTtcblxuICBjb25zdCBmaW5hbDogU2VhcmNoUmVzdWx0W10gPSBjaGVja0FjY2Vzc1Byb21pc2VzLmZpbHRlcigoaSkgPT4gIV8uaXNOdWxsKGkpKS5zbGljZShmcm9tLCBzaXplKTtcbiAgbG9nZ2VyLmRlYnVnKGBzZWFyY2ggcmVzdWx0cyAke2ZpbmFsPy5sZW5ndGh9YCk7XG5cbiAgY29uc3QgcmVzcG9uc2U6IFNlYXJjaFJlc3VsdHMgPSB7XG4gICAgb2JqZWN0czogZmluYWwsXG4gICAgdG90YWw6IGZpbmFsLmxlbmd0aCxcbiAgICB0aW1lOiBuZXcgRGF0ZSgpLnRvVVRDU3RyaW5nKCksXG4gIH07XG5cbiAgbG9nZ2VyLmRlYnVnKGB0b3RhbCByZXNwb25zZSAke2ZpbmFsLmxlbmd0aH1gKTtcbiAgcmV0dXJuIHJlc3BvbnNlO1xufVxuXG4vKipcbiAqIEVuZHBvaW50IGZvciBucG0gc2VhcmNoIHYxXG4gKiByZXE6ICdHRVQgLy0vdjEvc2VhcmNoP3RleHQ9cmVhY3Qmc2l6ZT0yMCZmcm9tPTAmcXVhbGl0eT0wLjY1JnBvcHVsYXJpdHk9MC45OCZtYWludGVuYW5jZT0wLjUnXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIChyb3V0ZSwgYXV0aCwgc3RvcmFnZSk6IHZvaWQge1xuICByb3V0ZS5nZXQoU0VBUkNIX0FQSV9FTkRQT0lOVFMuc2VhcmNoLCBhc3luYyAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAvLyBUT0RPOiBpbXBsZW1lbnQgcHJvcGVyIHJlc3VsdCBzY29yaW5nIHdlaWdodGVkIGJ5IHF1YWxpdHksIHBvcHVsYXJpdHkgYW5kIG1haW50ZW5hbmNlIHF1ZXJ5IHBhcmFtZXRlcnNcbiAgICBsZXQgW3RleHQsIHNpemUsIGZyb20gLyogLCBxdWFsaXR5LCBwb3B1bGFyaXR5LCBtYWludGVuYW5jZSAqL10gPSBbXG4gICAgICAndGV4dCcsXG4gICAgICAnc2l6ZScsXG4gICAgICAnZnJvbScgLyogLCAncXVhbGl0eScsICdwb3B1bGFyaXR5JywgJ21haW50ZW5hbmNlJyAqLyxcbiAgICBdLm1hcCgoaykgPT4gcmVxLnF1ZXJ5W2tdKTtcblxuICAgIHNpemUgPSBwYXJzZUludChzaXplKSB8fCAyMDtcbiAgICBmcm9tID0gcGFyc2VJbnQoZnJvbSkgfHwgMDtcblxuICAgIGNvbnN0IGlzSW50ZXJlc3RpbmcgPSBjb21waWxlVGV4dFNlYXJjaCh0ZXh0KTtcblxuICAgIGNvbnN0IHJlc3VsdFN0cmVhbSA9IHN0b3JhZ2Uuc2VhcmNoKDAsIHsgcmVxIH0pO1xuICAgIGxldCByZXN1bHRCdWYgPSBbXSBhcyBhbnk7XG4gICAgbGV0IGNvbXBsZXRlZCA9IGZhbHNlO1xuXG4gICAgcmVzdWx0U3RyZWFtLm9uKCdkYXRhJywgKHBrZzogU2VhcmNoUmVzdWx0W10gfCBQYWNrYWdlUmVzdWx0cykgPT4ge1xuICAgICAgLy8gcGFja2FnZXMgZnJvbSB0aGUgdXBzdHJlYW1zXG4gICAgICBpZiAoXy5pc0FycmF5KHBrZykpIHtcbiAgICAgICAgcmVzdWx0QnVmID0gcmVzdWx0QnVmLmNvbmNhdChcbiAgICAgICAgICAocGtnIGFzIFNlYXJjaFJlc3VsdFtdKS5maWx0ZXIoKHBrZ0l0ZW0pID0+IHtcbiAgICAgICAgICAgIGlmICghaXNJbnRlcmVzdGluZyhwa2dJdGVtPy5wYWNrYWdlKSkge1xuICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsb2dnZXIuZGVidWcoYFtyZW1vdGVdIHBrZyBuYW1lICR7cGtnSXRlbT8ucGFja2FnZT8ubmFtZX1gKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBwYWNrYWdlcyBmcm9tIGxvY2FsXG4gICAgICAgIC8vIGR1ZSBjb21wYWJpbGl0eSB3aXRoIGAvLS9hbGxgIHdlIGNhbm5vdCByZWZhY3RvciBzdG9yYWdlLnNlYXJjaCgpO1xuICAgICAgICBpZiAoIWlzSW50ZXJlc3RpbmcocGtnKSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBsb2dnZXIuZGVidWcoYFtsb2NhbF0gcGtnIG5hbWUgJHsocGtnIGFzIFBhY2thZ2VSZXN1bHRzKT8ubmFtZX1gKTtcbiAgICAgICAgcmVzdWx0QnVmLnB1c2gocGtnKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJlc3VsdFN0cmVhbS5vbignZXJyb3InLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ3NlYXJjaCBlbmRwb2ludCBoYXMgZmFpbGVkJyk7XG4gICAgICByZXMuc29ja2V0LmRlc3Ryb3koKTtcbiAgICB9KTtcblxuICAgIHJlc3VsdFN0cmVhbS5vbignZW5kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgaWYgKCFjb21wbGV0ZWQpIHtcbiAgICAgICAgY29tcGxldGVkID0gdHJ1ZTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHNlbmRSZXNwb25zZShyZXN1bHRCdWYsIHJlc3VsdFN0cmVhbSwgYXV0aCwgcmVxLCBmcm9tLCBzaXplKTtcbiAgICAgICAgICBsb2dnZXIuaW5mbygnc2VhcmNoIGVuZHBvaW50IG9rIHJlc3VsdHMgQHt0b3RhbH0nLCB7IHRvdGFsOiByZXNwb25zZS50b3RhbCB9KTtcbiAgICAgICAgICByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLk9LKS5qc29uKHJlc3BvbnNlKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKCdzZWFyY2ggZW5kcG9pbnQgaGFzIGZhaWxlZCBAe2Vycn0nLCB7IGVyciB9KTtcbiAgICAgICAgICBuZXh0KGVycik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLElBQUFBLE9BQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFDLE9BQUEsR0FBQUYsc0JBQUEsQ0FBQUMsT0FBQTtBQUVBLElBQUFFLFdBQUEsR0FBQUYsT0FBQTtBQUdBLElBQUFHLFVBQUEsR0FBQUgsT0FBQTtBQUNBLElBQUFJLE9B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