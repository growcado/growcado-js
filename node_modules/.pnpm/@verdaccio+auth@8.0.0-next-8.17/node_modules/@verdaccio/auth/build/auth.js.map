{"version":3,"file":"auth.js","names":["_debug","_interopRequireDefault","require","_lodash","_interopRequireWildcard","_verdaccioHtpasswd","_config","_core","_loaders","_signature","_utils","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","debug","buildDebug","Auth","constructor","config","logger","options","legacyMergeConfigs","secret","plugins","TypeError","init","loadPlugin","length","loadDefaultPlugin","_applyDefaultPlugins","pluginOptions","authPlugin","HTPasswd","file","info","name","pluginCategory","PLUGIN_CATEGORY","AUTHENTICATION","error","asyncLoadPlugin","auth","plugin","authenticate","allow_access","allow_publish","server","pluginPrefix","PLUGIN_PREFIX","push","getDefaultPlugins","changePassword","username","password","newPassword","cb","validPlugins","_","filter","isFunction","isEmpty","errorUtils","getInternalError","SUPPORT_ERRORS","PLUGIN_MISSING_INTERFACE","isNil","err","profile","invalidateToken","token","console","log","Promise","resolve","slice","next","shift","groups","message","isString","isGroupValid","isArray","API_ERROR","BAD_FORMAT_USER_GROUP","createRemoteUser","add_user","user","self","method","adduser","warningUtils","emit","Codes","VERWAR006","ok","packageName","packageVersion","callback","pkgAllowAccess","version","pkg","assign","authUtils","getMatchedPackagesSpec","packages","allow_unpublish","isError","apiJWTmiddleware","helpers","createAnonymousRemoteUser","req","res","_next","pause","resume","remote_user","remoteUser","locals","authorization","headers","isAuthHeaderValid","getBadRequest","BAD_AUTH_HEADER","security","isAESLegacy","handleAESMiddleware","handleJWTAPIMiddleware","scheme","parseAuthTokenHeader","toUpperCase","TOKEN_BASIC","credentials","convertPayloadToBase64","toString","parseBasicPayload","getMiddlewareCredentials","getForbidden","BAD_USERNAME_PASSWORD","_isRemoteUserValid","isUndefined","webUIJWTmiddleware","status","statusCode","send","replace","TOKEN_BEARER","verifyJWTPayload","jwtEncrypt","signOptions","real_groups","realGroupsValidated","groupedGroups","Array","from","Set","concat","payload","signPayload","aesEncrypt","value","TOKEN_VALID_LENGTH","aesEncryptDeprecated","Buffer","exports"],"sources":["../src/auth.ts"],"sourcesContent":["import buildDebug from 'debug';\nimport _, { isFunction } from 'lodash';\nimport { HTPasswd } from 'verdaccio-htpasswd';\n\nimport { TOKEN_VALID_LENGTH, createAnonymousRemoteUser, createRemoteUser } from '@verdaccio/config';\nimport {\n  API_ERROR,\n  PLUGIN_CATEGORY,\n  PLUGIN_PREFIX,\n  SUPPORT_ERRORS,\n  TOKEN_BASIC,\n  TOKEN_BEARER,\n  VerdaccioError,\n  authUtils,\n  errorUtils,\n  pluginUtils,\n  warningUtils,\n} from '@verdaccio/core';\nimport { asyncLoadPlugin } from '@verdaccio/loaders';\nimport {\n  aesEncrypt,\n  aesEncryptDeprecated,\n  parseBasicPayload,\n  signPayload,\n} from '@verdaccio/signature';\nimport {\n  AllowAccess,\n  Callback,\n  Config,\n  JWTSignOptions,\n  Logger,\n  PackageAccess,\n  RemoteUser,\n  Security,\n} from '@verdaccio/types';\n\nimport {\n  $RequestExtend,\n  $ResponseExtend,\n  AESPayload,\n  IAuthMiddleware,\n  NextFunction,\n  TokenEncryption,\n} from './types';\nimport {\n  convertPayloadToBase64,\n  getDefaultPlugins,\n  getMiddlewareCredentials,\n  isAESLegacy,\n  isAuthHeaderValid,\n  parseAuthTokenHeader,\n  verifyJWTPayload,\n} from './utils';\n\nconst debug = buildDebug('verdaccio:auth');\n\nclass Auth implements IAuthMiddleware, TokenEncryption, pluginUtils.IBasicAuth {\n  public config: Config;\n  public secret: string;\n  public logger: Logger;\n  public plugins: pluginUtils.Auth<Config>[];\n  public options: { legacyMergeConfigs: boolean };\n\n  public constructor(config: Config, logger: Logger, options = { legacyMergeConfigs: false }) {\n    this.config = config;\n    this.secret = config.secret;\n    this.logger = logger;\n    this.plugins = [];\n    this.options = options;\n    if (!this.secret) {\n      throw new TypeError('secret it is required value on initialize the auth class');\n    }\n  }\n\n  public async init() {\n    let plugins = (await this.loadPlugin()) as pluginUtils.Auth<unknown>[];\n\n    debug('auth plugins found %s', plugins.length);\n    if (!plugins || plugins.length === 0) {\n      plugins = this.loadDefaultPlugin();\n    }\n    this.plugins = plugins;\n\n    this._applyDefaultPlugins();\n  }\n\n  private loadDefaultPlugin() {\n    debug('load default auth plugin');\n    const pluginOptions: pluginUtils.PluginOptions = {\n      config: this.config,\n      logger: this.logger,\n    };\n    let authPlugin;\n    try {\n      authPlugin = new HTPasswd(\n        { file: './htpasswd' },\n        pluginOptions as any as pluginUtils.PluginOptions\n      );\n      this.logger.info(\n        { name: 'verdaccio-htpasswd', pluginCategory: PLUGIN_CATEGORY.AUTHENTICATION },\n        'plugin @{name} successfully loaded (@{pluginCategory})'\n      );\n    } catch (error: any) {\n      debug('error on loading auth htpasswd plugin stack: %o', error);\n      this.logger.info({}, 'no auth plugin has been found');\n      return [];\n    }\n\n    return [authPlugin];\n  }\n\n  private async loadPlugin() {\n    return asyncLoadPlugin<pluginUtils.Auth<unknown>>(\n      this.config.auth,\n      {\n        config: this.config,\n        logger: this.logger,\n      },\n      (plugin): boolean => {\n        const { authenticate, allow_access, allow_publish } = plugin;\n\n        return (\n          typeof authenticate !== 'undefined' ||\n          typeof allow_access !== 'undefined' ||\n          typeof allow_publish !== 'undefined'\n        );\n      },\n      this.options.legacyMergeConfigs,\n      this.config?.server?.pluginPrefix ?? PLUGIN_PREFIX,\n      PLUGIN_CATEGORY.AUTHENTICATION\n    );\n  }\n\n  private _applyDefaultPlugins(): void {\n    // TODO: rename to applyFallbackPluginMethods\n    this.plugins.push(getDefaultPlugins(this.logger));\n  }\n\n  public changePassword(\n    username: string,\n    password: string,\n    newPassword: string,\n    cb: Callback\n  ): void {\n    const validPlugins = _.filter(this.plugins, (plugin) => _.isFunction(plugin.changePassword));\n\n    if (_.isEmpty(validPlugins)) {\n      return cb(errorUtils.getInternalError(SUPPORT_ERRORS.PLUGIN_MISSING_INTERFACE));\n    }\n\n    for (const plugin of validPlugins) {\n      if (_.isNil(plugin) || _.isFunction(plugin.changePassword) === false) {\n        debug('auth plugin does not implement changePassword, trying next one');\n        continue;\n      } else {\n        debug('updating password for %o', username);\n        plugin.changePassword!(username, password, newPassword, (err, profile): void => {\n          if (err) {\n            this.logger.error(\n              { username, err },\n              `An error has been produced\n            updating the password for @{username}. Error: @{err.message}`\n            );\n            return cb(err);\n          }\n\n          debug('updated password for %o was successful', username);\n          return cb(null, profile);\n        });\n      }\n    }\n  }\n\n  public async invalidateToken(token: string) {\n    // eslint-disable-next-line no-console\n    console.log('invalidate token pending to implement', token);\n    return Promise.resolve();\n  }\n\n  public authenticate(\n    username: string,\n    password: string,\n    cb: (error: VerdaccioError | null, user?: RemoteUser) => void\n  ): void {\n    const plugins = this.plugins.slice(0);\n    (function next(): void {\n      const plugin = plugins.shift() as pluginUtils.Auth<Config>;\n\n      if (isFunction(plugin.authenticate) === false) {\n        return next();\n      }\n\n      debug('authenticating %o', username);\n      plugin.authenticate(username, password, function (err: VerdaccioError | null, groups): void {\n        if (err) {\n          debug('authenticating for user %o failed. Error: %o', username, err?.message);\n          return cb(err);\n        }\n\n        // Expect: SKIP if groups is falsey and not an array\n        //         with at least one item (truthy length)\n        // Expect: CONTINUE otherwise (will error if groups is not\n        //         an array, but this is current behavior)\n        // Caveat: STRING (if valid) will pass successfully\n        //         bug give unexpected results\n        // Info: Cannot use `== false to check falsey values`\n        if (!!groups && groups.length !== 0) {\n          // TODO: create a better understanding of expectations\n          if (_.isString(groups)) {\n            throw new TypeError('plugin group error: invalid type for function');\n          }\n          const isGroupValid: boolean = _.isArray(groups);\n          if (!isGroupValid) {\n            throw new TypeError(API_ERROR.BAD_FORMAT_USER_GROUP);\n          }\n\n          debug('authentication for user %o was successfully. Groups: %o', username, groups);\n          return cb(err, createRemoteUser(username, groups));\n        }\n        next();\n      });\n    })();\n  }\n\n  public add_user(\n    user: string,\n    password: string,\n    cb: (error: VerdaccioError | null, user?: RemoteUser) => void\n  ): void {\n    const self = this;\n    const plugins = this.plugins.slice(0);\n    debug('add user %o', user);\n\n    (function next(): void {\n      let method = 'adduser';\n      const plugin = plugins.shift() as pluginUtils.Auth<Config>;\n      // @ts-expect-error future major (7.x) should remove this section\n      if (typeof plugin.adduser === 'undefined' && typeof plugin.add_user === 'function') {\n        method = 'add_user';\n        warningUtils.emit(warningUtils.Codes.VERWAR006);\n      }\n      // @ts-ignore\n      if (typeof plugin[method] !== 'function') {\n        next();\n      } else {\n        // TODO: replace by adduser whenever add_user deprecation method has been removed\n        // @ts-ignore\n        plugin[method](\n          user,\n          password,\n          function (err: VerdaccioError | null, ok?: boolean | string): void {\n            if (err) {\n              debug('the user %o could not be added. Error: %o', user, err?.message);\n              return cb(err);\n            }\n            if (ok) {\n              debug('the user %o has been added', user);\n              return self.authenticate(user, password, cb);\n            }\n            debug('user could not be added, skip to next auth plugin');\n            next();\n          }\n        );\n      }\n    })();\n  }\n\n  /**\n   * Allow user to access a package.\n   */\n  public allow_access(\n    { packageName, packageVersion }: pluginUtils.AuthPluginPackage,\n    user: RemoteUser,\n    callback: pluginUtils.AccessCallback\n  ): void {\n    const plugins = this.plugins.slice(0);\n    const pkgAllowAccess: AllowAccess = { name: packageName, version: packageVersion };\n    const pkg = Object.assign(\n      {},\n      pkgAllowAccess,\n      authUtils.getMatchedPackagesSpec(packageName, this.config.packages)\n    ) as AllowAccess & PackageAccess;\n    debug('allow access for %o', packageName);\n\n    (function next(): void {\n      const plugin: pluginUtils.Auth<unknown> = plugins.shift() as pluginUtils.Auth<unknown>;\n\n      if (_.isNil(plugin) || isFunction(plugin.allow_access) === false) {\n        return next();\n      }\n\n      plugin.allow_access!(user, pkg, function (err: VerdaccioError | null, ok?: boolean): void {\n        if (err) {\n          debug('forbidden access for %o. Error: %o', packageName, err?.message);\n          return callback(err);\n        }\n\n        if (ok) {\n          debug('allowed access for %o', packageName);\n          return callback(null, ok);\n        }\n\n        next(); // cb(null, false) causes next plugin to roll\n      });\n    })();\n  }\n\n  public allow_unpublish(\n    { packageName, packageVersion }: pluginUtils.AuthPluginPackage,\n    user: RemoteUser,\n    callback: Callback\n  ): void {\n    const pkg = Object.assign(\n      { name: packageName, version: packageVersion },\n      authUtils.getMatchedPackagesSpec(packageName, this.config.packages)\n    );\n    debug('allow unpublish for %o', packageName);\n\n    for (const plugin of this.plugins) {\n      if (typeof plugin?.allow_unpublish !== 'function') {\n        debug('allow unpublish for %o plugin does not implement allow_unpublish', packageName);\n        continue;\n      } else {\n        plugin.allow_unpublish(user, pkg, (err, ok): void => {\n          if (err) {\n            debug(\n              'forbidden publish for %o, it will fallback on unpublish permissions',\n              packageName\n            );\n            return callback(err);\n          }\n\n          if (_.isNil(ok) === true) {\n            debug('bypass unpublish for %o, publish will handle the access', packageName);\n            return this.allow_publish({ packageName, packageVersion }, user, callback);\n          }\n\n          if (ok) {\n            debug('allowed unpublish for %o', packageName);\n            return callback(null, ok);\n          }\n        });\n      }\n    }\n  }\n\n  /**\n   * Allow user to publish a package.\n   */\n  public allow_publish(\n    { packageName, packageVersion }: pluginUtils.AuthPluginPackage,\n    user: RemoteUser,\n    callback: Callback\n  ): void {\n    const plugins = this.plugins.slice(0);\n    const pkg = Object.assign(\n      { name: packageName, version: packageVersion },\n      authUtils.getMatchedPackagesSpec(packageName, this.config.packages)\n    );\n    debug('allow publish for %o init | plugins: %o', packageName, plugins.length);\n\n    (function next(): void {\n      const plugin = plugins.shift();\n\n      if (typeof plugin?.allow_publish !== 'function') {\n        debug('allow publish for %o plugin does not implement allow_publish', packageName);\n        return next();\n      }\n\n      plugin.allow_publish(user, pkg, (err: VerdaccioError | null, ok?: boolean): void => {\n        if (_.isNil(err) === false && _.isError(err)) {\n          debug('forbidden publish for %o', packageName);\n          return callback(err);\n        }\n\n        if (ok) {\n          debug('allowed publish for %o', packageName);\n          return callback(null, ok);\n        }\n\n        debug('allow publish skip validation for %o', packageName);\n        next(); // cb(null, false) causes next plugin to roll\n      });\n    })();\n  }\n\n  public apiJWTmiddleware(): any {\n    debug('jwt middleware');\n    const plugins = this.plugins.slice(0);\n    const helpers = { createAnonymousRemoteUser, createRemoteUser };\n    for (const plugin of plugins) {\n      if (plugin.apiJWTmiddleware) {\n        return plugin.apiJWTmiddleware(helpers);\n      }\n    }\n\n    return (req: $RequestExtend, res: $ResponseExtend, _next: NextFunction) => {\n      req.pause();\n      const next = function (err?: VerdaccioError): NextFunction {\n        req.resume();\n        // uncomment this to reject users with bad auth headers\n        // return _next.apply(null, arguments)\n        // swallow error, user remains unauthorized\n        // set remoteUserError to indicate that user was attempting authentication\n        if (err) {\n          req.remote_user.error = err.message;\n        }\n\n        return _next() as unknown as NextFunction;\n      };\n\n      // FUTURE: disabled, not removed yet but seems unreacable code\n      // if (this._isRemoteUserValid(req.remote_user)) {\n      //   debug('jwt has a valid authentication header');\n      //   return next();\n      // }\n\n      // in case auth header does not exist we return anonymous function\n      const remoteUser = createAnonymousRemoteUser();\n      req.remote_user = remoteUser;\n      res.locals.remote_user = remoteUser;\n\n      const { authorization } = req.headers;\n      if (_.isNil(authorization)) {\n        debug('jwt, authentication header is missing');\n        return next();\n      }\n\n      if (!isAuthHeaderValid(authorization)) {\n        debug('api middleware authentication heather is invalid');\n        return next(errorUtils.getBadRequest(API_ERROR.BAD_AUTH_HEADER));\n      }\n      const { secret, security } = this.config;\n\n      if (isAESLegacy(security)) {\n        debug('api middleware using legacy auth token');\n        this.handleAESMiddleware(req, security, secret, authorization, next);\n      } else {\n        debug('api middleware using JWT auth token');\n        this.handleJWTAPIMiddleware(req, security, secret, authorization, next);\n      }\n    };\n  }\n\n  private handleJWTAPIMiddleware(\n    req: $RequestExtend,\n    security: Security,\n    secret: string,\n    authorization: string,\n    next: any\n  ): void {\n    debug('handle JWT api middleware');\n    const { scheme, token } = parseAuthTokenHeader(authorization);\n    if (scheme.toUpperCase() === TOKEN_BASIC.toUpperCase()) {\n      debug('handle basic token');\n      // this should happen when client tries to login with an existing user\n      const credentials = convertPayloadToBase64(token).toString();\n      const { user, password } = parseBasicPayload(credentials) as AESPayload;\n      debug('authenticating %o', user);\n      this.authenticate(user, password, (err: VerdaccioError | null, user): void => {\n        if (!err) {\n          debug('generating a remote user');\n          req.remote_user = user;\n          next();\n        } else {\n          debug('generating anonymous user');\n          req.remote_user = createAnonymousRemoteUser();\n          next(err);\n        }\n      });\n    } else {\n      debug('handle jwt token');\n      const credentials: any = getMiddlewareCredentials(security, secret, authorization);\n      if (credentials) {\n        // if the signature is valid we rely on it\n        req.remote_user = credentials;\n        debug('generating a remote user');\n        next();\n      } else {\n        // with JWT throw 401\n        debug('jwt invalid token');\n        next(errorUtils.getForbidden(API_ERROR.BAD_USERNAME_PASSWORD));\n      }\n    }\n  }\n\n  private handleAESMiddleware(\n    req: $RequestExtend,\n    security: Security,\n    secret: string,\n    authorization: string,\n    next: Function\n  ): void {\n    debug('handle legacy api middleware');\n    debug('api middleware has a secret? %o', typeof secret === 'string');\n    debug('api middleware authorization %o', typeof authorization === 'string');\n    const credentials: any = getMiddlewareCredentials(security, secret, authorization);\n    debug('api middleware credentials %o', credentials?.name);\n    if (credentials) {\n      const { user, password } = credentials;\n      debug('authenticating %o', user);\n      this.authenticate(user, password, (err, user): void => {\n        if (!err) {\n          req.remote_user = user;\n          debug('generating a remote user');\n          next();\n        } else {\n          req.remote_user = createAnonymousRemoteUser();\n          debug('generating anonymous user');\n          next(err);\n        }\n      });\n    } else {\n      // we force npm client to ask again with basic authentication\n      debug('legacy invalid header');\n      return next(errorUtils.getBadRequest(API_ERROR.BAD_AUTH_HEADER));\n    }\n  }\n\n  private _isRemoteUserValid(remote_user?: RemoteUser): boolean {\n    return _.isUndefined(remote_user) === false && _.isUndefined(remote_user?.name) === false;\n  }\n\n  /**\n   * JWT middleware for WebUI\n   */\n  public webUIJWTmiddleware() {\n    return (req: $RequestExtend, res: $ResponseExtend, _next: NextFunction): void => {\n      if (this._isRemoteUserValid(req.remote_user)) {\n        return _next();\n      }\n\n      req.pause();\n      const next = (err: VerdaccioError | void): void => {\n        req.resume();\n        if (err) {\n          req.remote_user.error = err.message;\n          res.status(err.statusCode).send(err.message);\n        }\n\n        return _next();\n      };\n\n      const { authorization } = req.headers;\n      if (_.isNil(authorization)) {\n        return next();\n      }\n\n      if (!isAuthHeaderValid(authorization)) {\n        return next(errorUtils.getBadRequest(API_ERROR.BAD_AUTH_HEADER));\n      }\n\n      const token = (authorization || '').replace(`${TOKEN_BEARER} `, '');\n      if (!token) {\n        return next();\n      }\n\n      let credentials: RemoteUser | undefined;\n      try {\n        credentials = verifyJWTPayload(token, this.config.secret, this.config.security);\n      } catch (err: any) {\n        // FIXME: intended behaviour, do we want it?\n      }\n\n      if (this._isRemoteUserValid(credentials)) {\n        const { name, groups } = credentials as RemoteUser;\n        req.remote_user = createRemoteUser(name as string, groups);\n      } else {\n        req.remote_user = createAnonymousRemoteUser();\n      }\n\n      next();\n    };\n  }\n\n  public async jwtEncrypt(user: RemoteUser, signOptions: JWTSignOptions): Promise<string> {\n    const { real_groups, name, groups } = user;\n    debug('jwt encrypt %o', name);\n    const realGroupsValidated = _.isNil(real_groups) ? [] : real_groups;\n    const groupedGroups = _.isNil(groups)\n      ? real_groups\n      : Array.from(new Set([...groups.concat(realGroupsValidated)]));\n    const payload: RemoteUser = {\n      real_groups: realGroupsValidated,\n      name,\n      groups: groupedGroups,\n    };\n    const token: string = await signPayload(payload, this.secret, signOptions);\n\n    return token;\n  }\n\n  /**\n   * Encrypt a string.\n   */\n  public aesEncrypt(value: string): string | void {\n    if (this.secret.length === TOKEN_VALID_LENGTH) {\n      debug('signing with enhanced aes legacy');\n      const token = aesEncrypt(value, this.secret);\n      return token;\n    } else {\n      debug('signing with enhanced aes deprecated legacy');\n      // deprecated aes (legacy) signature, only must be used for legacy version\n      const token = aesEncryptDeprecated(Buffer.from(value), this.secret).toString('base64');\n      return token;\n    }\n  }\n}\n\nexport { Auth };\n"],"mappings":"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","ignoreList":[]}